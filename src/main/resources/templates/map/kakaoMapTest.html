<!DOCTYPE html>
<html>
<head>
    <title>ì£¼ë³€ ë³‘ì› ì°¾ê¸°</title>
    <style>
        #map { width: 75%; height: 800px; float: right; }
        #sidebar {
            width: 25%;
            height: 750px;
            float: left;
            background: #f8f9fa;
            padding: 10px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        #searchContainer {
            display: flex;
            margin-bottom: 10px;
            align-items: center;
        }
        #searchInput {
            flex: 1;
            padding: 8px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        #searchButton {
            padding: 8px;
            font-size: 14px;
            margin-left: 5px;
            cursor: pointer;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 4px;
            transition: background 0.2s;
        }
        #searchButton:hover {
            background-color: #0056b3;
        }
        #nearbyCheckboxContainer {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        #hospitalList {
            flex-grow: 1;
            overflow-y: scroll;
        }
        .hospital-item {
            cursor: pointer;
            padding: 12px;
            border-bottom: 1px solid #ddd;
            font-size: 14px;
        }
        .hospital-item:hover { background-color: #e9ecef; }
        .highlight {
            background-color: #ffeb3b;
            font-weight: bold;
        }
        .directions-container {
            width: 100%;
            height: 50px;
            background: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .directions-btn {
            background: #d6d6d6;
            color: black;
            border: none;
            border-radius: 5px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .directions-btn:hover {
            background: #bfbfbf;
        }
        #category-btns {
		  position: absolute;
		  top: 17px;
		  left: 10px;
		  z-index: 10;
		}
		
		#category-btns button {
		  padding: 8px;
		  margin: 2px;
		  cursor: pointer;
		}
    </style>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=1590e9c87b932ff3afa865646fc52061&libraries=services"></script>
</head>
<body>
    <div id="sidebar">
        <div id="searchContainer">
            <input type="text" id="searchInput" placeholder="ë³‘ì› ì´ë¦„ ê²€ìƒ‰">
            <button id="searchButton" onclick="fetchSearchResults()">ê²€ìƒ‰</button>
        </div>
        <div id="nearbyCheckboxContainer">
            <input type="checkbox" id="nearbyCheckbox" onchange="toggleNearbyHospitals()">
            <label for="nearbyCheckbox">ë‚´ ì£¼ë³€ ë³´ê¸°</label>
        </div>
        <div id="hospitalList"></div>
        <div class="directions-container">
            <button class="directions-btn" onclick="openKakaoDirections()">ê¸¸ì°¾ê¸°</button>
        </div>
    </div>
    <div id="map">
    	<div id="category-btns">
	        <button data-category="ìƒê¸‰ì¢…í•©ë³‘ì›">ğŸ¥ ìƒê¸‰ì¢…í•©ë³‘ì›</button>
	        <button data-category="ì¢…í•©ë³‘ì›">ğŸ¥ ì¢…í•©ë³‘ì›</button>
	        <button data-category="ë³‘ì›">ğŸ¥ ë³‘ì›</button>
	        <button data-category="ìš”ì–‘ë³‘ì›">ğŸ¥ ìš”ì–‘ë³‘ì›</button>
	        <button data-category="ì •ì‹ ë³‘ì›">ğŸ¥ ì •ì‹ ë³‘ì›</button>
	        <button data-category="ì˜ì›">ğŸ¥ ì˜ì›</button>
	        <button data-category="ì¹˜ê³¼ë³‘ì›">ğŸ¦· ì¹˜ê³¼ë³‘ì›</button>
	        <button data-category="ì¹˜ê³¼ì˜ì›">ğŸ¦· ì¹˜ê³¼ì˜ì›</button>
	        <button data-category="í•œë°©ë³‘ì›">ğŸŒ¿ í•œë°©ë³‘ì›</button>
	        <button data-category="í•œì˜ì›">ğŸŒ¿ í•œì˜ì›</button>
	        <button data-category="ë³´ê±´ì†Œ">ğŸ¥ ë³´ê±´ì†Œ</button>
	        <button data-category="ë³´ê±´ì§„ë£Œì†Œ">ğŸ¥ ë³´ê±´ì§„ë£Œì†Œ</button>
	        <button data-category="ë³´ê±´ì§€ì†Œ">ğŸ¥ ë³´ê±´ì§€ì†Œ</button>
	        <button data-category="ì¡°ì‚°ì›">ğŸ¼ ì¡°ì‚°ì›</button>
	        <button data-category="ì‘ê¸‰ì‹¤">ğŸš‘ ì‘ê¸‰ì‹¤</button>
	        <button data-category="ì•½êµ­">ğŸ’Š ì•½êµ­</button>
		</div>
	</div>


    <script>

    var map;
    var selectedMarker = null;
    var listElement = document.getElementById('hospitalList');
    var markers = []; // ë§ˆì»¤ë¥¼ ì €ì¥í•  ë°°ì—´

    function initMap() {
        map = new kakao.maps.Map(document.getElementById('map'), {
            center: new kakao.maps.LatLng(37.5665, 126.9780),
            level: 4
        });
    }
    function fetchNearbyHospitals() {
        fetch("/map/nearbyHospitals")
        .then(response => response.json())
        .then(data => {
            console.log(data); // ë°ì´í„° í™•ì¸ìš© ë¡œê·¸ ì¶”ê°€
            listElement.innerHTML = ""; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”
            clearMarkers(); // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
            data.sort((a, b) => a.distance - b.distance);
            data.forEach(place => {
                var marker = createMarker(place);
                var listItem = createListItem(place);
                listElement.appendChild(listItem);

                kakao.maps.event.addListener(marker, 'click', function() {
                    selectMarker(marker, place);
                });

                markers.push(marker); // ë§ˆì»¤ ë°°ì—´ì— ì¶”ê°€
            });
        })
        .catch(error => {
            console.error('There was a problem with the fetch operation:', error);
        });
    }
    function fetchSearchResults() {
        let keyword = document.getElementById('searchInput').value.trim();
        if (keyword === "") {
            alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
            return;
        }

        clearMarkers(); // Clear existing markers

        fetch(`/map/search/item?keyword=${encodeURIComponent(keyword)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                updateHospitalList(data);
            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
            });
    }

    function toggleNearbyHospitals() {
        var checkbox = document.getElementById('nearbyCheckbox');
        if (checkbox.checked) {
            fetchNearbyHospitals();
        } else {
            listElement.innerHTML = ""; // ëª©ë¡ ì´ˆê¸°í™”
            clearMarkers(); // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
        }
    }

    function clearMarkers() {
        markers.forEach(marker => marker.setMap(null)); // ì§€ë„ì—ì„œ ë§ˆì»¤ ì œê±°
        markers = []; // ë§ˆì»¤ ë°°ì—´ ì´ˆê¸°í™”
    }

    function createMarker(place) {
        var position = new kakao.maps.LatLng(place.LAT, place.LNG);

        var normalImage = new kakao.maps.MarkerImage(
            "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png",
            new kakao.maps.Size(33, 36)
        );

        var overImage = new kakao.maps.MarkerImage(
            "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png",
            new kakao.maps.Size(40, 42)
        );

        var clickImage = new kakao.maps.MarkerImage(
            "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png",
            new kakao.maps.Size(33, 36)
        );

        var marker = new kakao.maps.Marker({
            position: position,
            map: map,
            image: normalImage
        });

        var infowindow = new kakao.maps.InfoWindow({
            content: `<div style="padding:5px;">${place.NAME || "ì¥ì†Œ"}</div>`
        });

        kakao.maps.event.addListener(marker, 'mouseover', function() {
            if (selectedMarker !== marker) marker.setImage(overImage);
            infowindow.open(map, marker);
        });

        kakao.maps.event.addListener(marker, 'mouseout', function() {
            if (selectedMarker !== marker) marker.setImage(normalImage);
            infowindow.close();
        });

        return marker;
    }

    function createListItem(place) {
        var item = document.createElement('div');
        item.className = 'hospital-item';
        item.innerText = `${place.NAME || "ì¥ì†Œ"}`;

        item.onclick = function() {
        	window.location.href = `/map/hospitaldetail?name=${encodeURIComponent(place.NAME || "ì¥ì†Œ")}&address=${encodeURIComponent(place.ADDRESS)}&lat=${place.LAT}&lng=${place.LNG}&phone=${place.PHONE}`;
        };
        return item;
    }

    function selectMarker(marker, place) {
        if (selectedMarker) selectedMarker.setImage(new kakao.maps.MarkerImage(
            "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png",
            new kakao.maps.Size(33, 36)
        ));

        marker.setImage(new kakao.maps.MarkerImage(
            "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png",
            new kakao.maps.Size(33, 36)
        ));

        selectedMarker = marker;
        map.setCenter(marker.getPosition());

        highlightListItem(place);
    }

    function highlightListItem(place) {
        document.querySelectorAll('.hospital-item').forEach(item => item.classList.remove('highlight'));
        let targetItem = Array.from(document.querySelectorAll('.hospital-item')).find(item =>
            item.innerText.includes(place.NAME || "ì¥ì†Œ")
        );
        if (targetItem) {
            targetItem.classList.add('highlight');
            targetItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    function openKakaoDirections() {
        window.open("https://map.kakao.com", "_blank");
    }
    function updateHospitalList(data) {
        listElement.innerHTML = ""; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”

        if (data.length > 0) {
            var firstPlace = data[0];
            var position = new kakao.maps.LatLng(firstPlace.LAT, firstPlace.LNG);
            map.setCenter(position);
        }

        data.forEach(place => {
            var marker = createMarker(place);
            var listItem = createListItem(place);
            listElement.appendChild(listItem);

            kakao.maps.event.addListener(marker, 'click', function() {
                selectMarker(marker, place);
            });

            markers.push(marker); // ë§ˆì»¤ ë°°ì—´ì— ì¶”ê°€
        });
    }

    window.onload = initMap;

    </script>
</body>
</html>
