<!DOCTYPE html>
<html>
<head>
    <title>주변 병원 찾기</title>
    <style>
        #map { width: 75%; height: 800px; float: right; }
        #sidebar {
            width: 25%;
            height: 750px;
            float: left;
            background: #f8f9fa;
            padding: 10px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        #searchContainer {
            display: flex;
            margin-bottom: 10px;
            align-items: center;
        }
        #searchInput {
            flex: 1;
            padding: 8px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        #searchButton {
            padding: 8px;
            font-size: 14px;
            margin-left: 5px;
            cursor: pointer;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 4px;
            transition: background 0.2s;
        }
        #searchButton:hover {
            background-color: #0056b3;
        }
        #nearbyCheckboxContainer {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        #hospitalList {
            flex-grow: 1;
            overflow-y: scroll;
        }
        .hospital-item {
            cursor: pointer;
            padding: 12px;
            border-bottom: 1px solid #ddd;
            font-size: 14px;
        }
        .hospital-item:hover { background-color: #e9ecef; }
        .highlight {
            background-color: #ffeb3b;
            font-weight: bold;
        }
        .directions-container {
            width: 100%;
            height: 50px;
            background: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .directions-btn {
            background: #d6d6d6;
            color: black;
            border: none;
            border-radius: 5px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .directions-btn:hover {
            background: #bfbfbf;
        }
        #category-btns {
		  position: absolute;
		  top: 17px;
		  left: 10px;
		  z-index: 10;
		}
		
		#category-btns button {
		  padding: 8px;
		  margin: 2px;
		  cursor: pointer;
		}
    </style>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=1590e9c87b932ff3afa865646fc52061&libraries=services"></script>
</head>
<body>
    <div id="sidebar">
        <div id="searchContainer">
            <input type="text" id="searchInput" placeholder="병원 이름 검색">
            <button id="searchButton" onclick="fetchSearchResults()">검색</button>
        </div>
        <div id="nearbyCheckboxContainer">
            <input type="checkbox" id="nearbyCheckbox" onchange="toggleNearbyHospitals()">
            <label for="nearbyCheckbox">내 주변 보기</label>
        </div>
        <div id="hospitalList"></div>
        <div class="directions-container">
            <button class="directions-btn" onclick="openKakaoDirections()">길찾기</button>
        </div>
    </div>
    <div id="map">
    	<div id="category-btns">
		  <button data-category="FD6">병원</button>
		  <button data-category="CE7">응급실</button>
		  <button data-category="CS2">약국</button>
		</div>
	</div>

    <script>

    var map;
    var selectedMarker = null;
    var listElement = document.getElementById('hospitalList');
    var markers = []; // 마커를 저장할 배열

    function initMap() {
        map = new kakao.maps.Map(document.getElementById('map'), {
            center: new kakao.maps.LatLng(37.5665, 126.9780),
            level: 4
        });
    }

    function fetchNearbyHospitals() {
        fetch("/map/nearbyHospitals")
        .then(response => response.json())
        .then(data => {
            listElement.innerHTML = ""; // 기존 목록 초기화
            clearMarkers(); // 기존 마커 제거
            data.sort((a, b) => a.distance - b.distance);
            data.forEach(place => {
                var marker = createMarker(place);
                var listItem = createListItem(place);
                listElement.appendChild(listItem);

                kakao.maps.event.addListener(marker, 'click', function() {
                    selectMarker(marker, place);
                });

                markers.push(marker); // 마커 배열에 추가
            });
        });
    }
    function fetchSearchResults() {
        let keyword = document.getElementById('searchInput').value.trim();
        if (keyword === "") {
            alert('검색어를 입력하세요');
            return;
        }

        clearMarkers(); // Clear existing markers

        fetch(`/map/search/item?keyword=${encodeURIComponent(keyword)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                updateHospitalList(data);
            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
            });
    }

    function toggleNearbyHospitals() {
        var checkbox = document.getElementById('nearbyCheckbox');
        if (checkbox.checked) {
            fetchNearbyHospitals();
        } else {
            listElement.innerHTML = ""; // 목록 초기화
            clearMarkers(); // 기존 마커 제거
        }
    }

    function clearMarkers() {
        markers.forEach(marker => marker.setMap(null)); // 지도에서 마커 제거
        markers = []; // 마커 배열 초기화
    }

    function createMarker(place) {
        var position = new kakao.maps.LatLng(place.LAT, place.LNG);

        var normalImage = new kakao.maps.MarkerImage(
            "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png",
            new kakao.maps.Size(33, 36)
        );

        var overImage = new kakao.maps.MarkerImage(
            "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png",
            new kakao.maps.Size(40, 42)
        );

        var clickImage = new kakao.maps.MarkerImage(
            "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png",
            new kakao.maps.Size(33, 36)
        );

        var marker = new kakao.maps.Marker({
            position: position,
            map: map,
            image: normalImage
        });

        var infowindow = new kakao.maps.InfoWindow({
            content: `<div style="padding:5px;">${place.NAME || "장소"}</div>`
        });

        kakao.maps.event.addListener(marker, 'mouseover', function() {
            if (selectedMarker !== marker) marker.setImage(overImage);
            infowindow.open(map, marker);
        });

        kakao.maps.event.addListener(marker, 'mouseout', function() {
            if (selectedMarker !== marker) marker.setImage(normalImage);
            infowindow.close();
        });

        return marker;
    }

    function createListItem(place) {
        var item = document.createElement('div');
        item.className = 'hospital-item';
        item.innerText = `${place.NAME || "장소"}`;

        item.onclick = function() {
        	window.location.href = `/map/hospitaldetail?name=${encodeURIComponent(place.NAME || "장소")}&address=${encodeURIComponent(place.ADDRESS)}&lat=${place.LAT}&lng=${place.LNG}&phone=${place.PHONE}`;
        };
        return item;
    }

    function selectMarker(marker, place) {
        if (selectedMarker) selectedMarker.setImage(new kakao.maps.MarkerImage(
            "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png",
            new kakao.maps.Size(33, 36)
        ));

        marker.setImage(new kakao.maps.MarkerImage(
            "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png",
            new kakao.maps.Size(33, 36)
        ));

        selectedMarker = marker;
        map.setCenter(marker.getPosition());

        highlightListItem(place);
    }

    function highlightListItem(place) {
        document.querySelectorAll('.hospital-item').forEach(item => item.classList.remove('highlight'));
        let targetItem = Array.from(document.querySelectorAll('.hospital-item')).find(item =>
            item.innerText.includes(place.NAME || "장소")
        );
        if (targetItem) {
            targetItem.classList.add('highlight');
            targetItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    function openKakaoDirections() {
        window.open("https://map.kakao.com", "_blank");
    }
    function updateHospitalList(data) {
        listElement.innerHTML = ""; // 기존 목록 초기화

        if (data.length > 0) {
            var firstPlace = data[0];
            var position = new kakao.maps.LatLng(firstPlace.LAT, firstPlace.LNG);
            map.setCenter(position);
        }

        data.forEach(place => {
            var marker = createMarker(place);
            var listItem = createListItem(place);
            listElement.appendChild(listItem);

            kakao.maps.event.addListener(marker, 'click', function() {
                selectMarker(marker, place);
            });

            markers.push(marker); // 마커 배열에 추가
        });
    }

    window.onload = initMap;

    </script>
</body>
</html>
